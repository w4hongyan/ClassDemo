<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬14è¯¾ï¼šç¼–ç ä¹Ÿèƒ½åŠ¨èµ·æ¥</title>
    <style>
        :root {
            --primary-color: #88c999; /* è¯¾ä»¶ä¸­çš„ç»¿è‰²åŸºè°ƒ */
            --accent-color: #ffa500;  /* æ©™è‰²é‡ç‚¹ */
            --text-color: #333;
            --bg-color: #f0f9f4;
            --box-color: #e67e22;
            --wall-color: #95a5a6;
            --player-color: #2ecc71;
            --goal-color: #f1c40f;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* å¯¼èˆªä¸å¸ƒå±€ */
        header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 1.5rem; color: #2c3e50; }
        .subtitle { font-size: 0.9rem; color: #7f8c8d; }

        section {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }

        section:hover { transform: translateY(-5px); }

        h2 { border-left: 5px solid var(--primary-color); padding-left: 10px; color: #2c3e50; }
        
        .highlight { color: var(--box-color); font-weight: bold; }

        /* æ¸¸æˆç½‘æ ¼é€šç”¨æ ·å¼ */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .grid-board {
            display: grid;
            gap: 2px;
            background-color: #bdc3c7;
            border: 5px solid #bdc3c7;
            border-radius: 5px;
        }

        .cell {
            width: 50px;
            height: 50px;
            background-color: #e8f5e9;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            position: relative;
        }

        .cell.wall { background-color: var(--wall-color); background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h40v40H0V0zm20 20h20v20H20V20zM0 20h20v20H0V20zM20 0h20v20H20V0zM0 0h20v20H0V0z' fill='%237f8c8d' fill-opacity='0.1' fill-rule='evenodd'/%3E"); }
        .cell.goal { background-color: #fff9c4; border: 2px dashed var(--goal-color); box-sizing: border-box; }
        .cell.goal::after { content: 'â˜…'; color: var(--goal-color); font-size: 30px; }

        /* æ¸¸æˆè§’è‰²æ ·å¼ */
        .sprite {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            position: absolute;
            transition: all 0.2s ease;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .sprite.player { background-color: var(--player-color); border: 2px solid #27ae60; }
        .sprite.player::after { content: 'â˜º'; color: white; display:flex; justify-content:center; align-items:center; height:100%; font-size:20px;}
        
        .sprite.box { 
            background-color: var(--box-color); 
            border-radius: 5px; 
            border: 2px solid #d35400;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }
        .sprite.box::before { content: 'X'; font-family: monospace; font-size: 24px;}

        /* æ§åˆ¶æŒ‰é’®åŒºåŸŸ */
        .controls { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;}
        .controls button {
            margin: 5px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
            background-color: var(--primary-color);
            color: white;
        }
        button:hover { background-color: #66bb6a; transform: scale(1.05); }
        button:active { transform: scale(0.95); }
        button.secondary { background-color: #95a5a6; }
        button.action-btn { background-color: var(--accent-color); }

        /* ç¼–ç å±•ç¤ºåŒºåŸŸ */
        .code-display {
            background: #2d3436;
            color: #fab1a0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            margin-top: 15px;
            min-height: 40px;
            width: 100%;
            text-align: left;
            position: relative;
            overflow-x: auto;
        }
        .code-display::before { content: 'ç”Ÿæˆçš„åŠ¨ä½œç¼–ç :'; display: block; color: #74b9ff; font-size: 12px; margin-bottom: 5px;}

        /* è¡¨æ ¼æ ·å¼ */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .comparison-table th { background-color: var(--primary-color); color: white; }

        /* åŠ¨ç”»æç¤º */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }
        .bounce { animation: bounce 2s infinite; }

        /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .step-dot {
            width: 12px;
            height: 12px;
            background: #ddd;
            border-radius: 50%;
            margin: 0 5px;
            cursor: pointer;
        }
        .step-dot.active { background: var(--primary-color); transform: scale(1.2); }

        /* æ‹“å±•ä½œä¸šå¡ç‰‡ */
        .homework-card {
            background: #fff3e0;
            border-left: 5px solid #ff9800;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>ç¬¬14è¯¾ ç¼–ç ä¹Ÿèƒ½åŠ¨èµ·æ¥</h1>
        <span class="subtitle">ä¹‰åŠ¡æ•™è‚²ä¿¡æ¯ç§‘æŠ€è¯¾ç¨‹èµ„æº Â· å››å¹´çº§</span>
    </div>
    <div style="font-size: 0.9rem; background: #eee; padding: 5px 10px; border-radius: 15px;">
        ğŸ‘©â€ğŸ« äº’åŠ¨æ•™å­¦æ¨¡å¼
    </div>
</header>

<section id="part1">
    <h2>1. é—®é¢˜æƒ…å¢ƒï¼šæ¨ç®±å­</h2>
    <p>åŒå­¦ä»¬ï¼Œä½ ä»¬ç©è¿‡â€œæ¨ç®±å­â€çš„æ¸¸æˆå—ï¼ŸğŸ“¦</p>
    <div style="display: flex; gap: 20px; align-items: flex-start;">
        <div style="flex: 1;">
            <p><strong>æ€è€ƒï¼š</strong>åœ¨æ²¡æœ‰ç½‘æ ¼çš„ç™½çº¸ä¸Šæè¿°æ€ä¹ˆèµ°ï¼Œå’Œåœ¨æœ‰ç½‘æ ¼çš„æ£‹ç›˜ä¸Šæè¿°ï¼Œå“ªä¸ªæ›´æ¸…æ¥šï¼Ÿ</p>
            <ul>
                <li>âŒ æ— ç½‘æ ¼ï¼šå¾€é‚£è¾¹èµ°ä¸€ç‚¹ï¼Œå†å¾€ä¸Šèµ°ä¸€ç‚¹...ï¼ˆæ¨¡ç³Šï¼‰</li>
                <li>âœ… æœ‰ç½‘æ ¼ï¼šå‘å³èµ°2æ ¼ï¼Œå‘ä¸Šæ¨1æ ¼...ï¼ˆç²¾å‡†ï¼‰</li>
            </ul>
        </div>
        <div style="flex: 1; text-align: center;">
            <img src="data:image/svg+xml,%3Csvg width='200' height='150' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100%25' height='100%25' fill='%23eee'/%3E%3Cpath d='M0 50h200M0 100h200M50 0v150M100 0v150M150 0v150' stroke='%23ccc' stroke-width='2'/%3E%3Ccircle cx='75' cy='125' r='15' fill='%232ecc71'/%3E%3Crect x='105' y='60' width='40' height='40' fill='%23e67e22' stroke='%23d35400' stroke-width='2'/%3E%3Ctext x='117' y='88' font-family='monospace' fill='white' font-size='20'%3EX%3C/text%3E%3C/svg%3E" alt="ç½‘æ ¼ç¤ºæ„å›¾">
            <p style="font-size: 12px; color: #666;">ç½‘æ ¼èµ·åˆ°äº†åæ ‡å’Œåº¦é‡çš„ä½œç”¨</p>
        </div>
    </div>
</section>

<section id="part2">
    <h2>2. å­¦ä¹ æ´»åŠ¨ä¸€ï¼šæ¨ç®±å­ï¼ˆç¬¬ä¸€å…³ï¼‰</h2>
    <p>è¯·ä½ è¯•ç€ç©ä¸€ç©è¿™ä¸ªå°æ¸¸æˆï¼ŒæŠŠç»¿è‰²çš„åœ†çƒï¼ˆç©å®¶ï¼‰ç§»åŠ¨ï¼Œæ¨åŠ¨æ©™è‰²çš„ç®±å­ï¼Œç›´åˆ°æŠŠç®±å­æ¨åˆ°æ˜Ÿæ˜Ÿï¼ˆç›®çš„åœ°ï¼‰ä½ç½®ã€‚</p>
    <div class="tip" style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
        ğŸ’¡ æç¤ºï¼šä½¿ç”¨ä¸‹æ–¹çš„<strong>æ–¹å‘æŒ‰é’®</strong>æˆ–é”®ç›˜<strong>æ–¹å‘é”®</strong>æ¥æ§åˆ¶ã€‚
    </div>

    <div class="game-container" id="game-level-1">
        <div class="grid-board" id="board-1"></div>
        <div class="controls">
            <button onclick="game1.move(0, -1)">â†‘ å‘ä¸Š</button>
            <div style="width: 100%; height: 0;"></div> <button onclick="game1.move(-1, 0)">â† å‘å·¦</button>
            <button onclick="game1.move(0, 1)">â†“ å‘ä¸‹</button>
            <button onclick="game1.move(1, 0)">â†’ å‘å³</button>
            <button class="secondary" onclick="game1.reset()">â†º é‡ç½®</button>
        </div>
        <div id="status-1" style="margin-top: 10px; font-weight: bold; color: var(--primary-color);"></div>
    </div>
</section>

<section id="part3">
    <h2>3. å­¦ä¹ æ´»åŠ¨äºŒï¼šè®¾è®¡åŠ¨ä½œç¼–ç </h2>
    <p>åˆšæ‰æˆ‘ä»¬ç©æ¸¸æˆçš„è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯æ‰§è¡Œä¸€ç³»åˆ—â€œåŠ¨ä½œâ€ã€‚å¦‚æœæˆ‘ä»¬è¦æŠŠè¿‡å…³çš„æ–¹æ³•è®°å½•ä¸‹æ¥ï¼Œå‘ç»™ä½ çš„å¥½æœ‹å‹ï¼Œæ€ä¹ˆå†™æœ€ç®€å•ï¼Ÿ</p>
    
    <div style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
        <h3>ç¼–ç å¤§æ¯”æ‹¼</h3>
        <p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸åŒçš„ç¬¦å·æ¥ä»£è¡¨æ–¹å‘ï¼š</p>
        <table class="comparison-table">
            <tr>
                <th>ç¼–ç ç±»å‹</th>
                <th>å‘ä¸Š</th>
                <th>å‘ä¸‹</th>
                <th>å‘å·¦</th>
                <th>å‘å³</th>
                <th>ç‰¹ç‚¹</th>
            </tr>
            <tr>
                <td>ä¸­æ–‡æè¿°</td>
                <td>ä¸Š</td>
                <td>ä¸‹</td>
                <td>å·¦</td>
                <td>å³</td>
                <td>é€šä¿—æ˜“æ‡‚</td>
            </tr>
            <tr>
                <td>ç¬¦å·å›¾å½¢</td>
                <td>â†‘</td>
                <td>â†“</td>
                <td>â†</td>
                <td>â†’</td>
                <td>ç›´è§‚ç®€æ´</td>
            </tr>
            <tr>
                <td>è‹±æ–‡ç¼©å†™</td>
                <td>up</td>
                <td>dw</td>
                <td>lt</td>
                <td>rt</td>
                <td>å›½é™…åŒ–</td>
            </tr>
        </table>
        <p><strong>ç»“è®ºï¼š</strong>ç¼–ç è¦éµå¾ª<strong>å”¯ä¸€æ€§ã€ç®€æ´æ€§ã€å‡†ç¡®æ€§</strong>çš„åŸåˆ™ã€‚</p>
    </div>
</section>

<section id="part4">
    <h2>4. å­¦ä¹ æ´»åŠ¨ä¸‰ï¼šæ¨ç®±å­ï¼ˆç¬¬äºŒå…³ï¼‰â€”â€” ç¼–ç æŒ‘æˆ˜</h2>
    <p>éš¾åº¦å‡çº§äº†ï¼è¿™æ¬¡æˆ‘ä»¬ä¸ç›´æ¥æ§åˆ¶ï¼Œè€Œæ˜¯è¦<strong>å…ˆå†™å¥½ç¼–ç ï¼ˆå‘½ä»¤åºåˆ—ï¼‰</strong>ï¼Œç„¶åè®©è®¡ç®—æœºä¸€æ¬¡æ€§æ‰§è¡Œã€‚è¿™å°±æ˜¯â€œç¼–ç¨‹â€çš„æ€ç»´ï¼</p>
    
    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 300px;">
            <div class="game-container">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; margin-bottom: 10px;">
                    <span style="font-weight: bold;">å½“å‰å…³å¡ï¼š</span>
                    <button class="secondary" onclick="coder.prevLevel()">ä¸Šä¸€å…³</button>
                    <select id="level-select" onchange="coder.setLevel(parseInt(this.value, 10))" style="padding: 10px 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 16px; background: white;"></select>
                    <button class="secondary" onclick="coder.nextLevel()">ä¸‹ä¸€å…³</button>
                    <span id="level-hint" style="font-size: 14px; color: #7f8c8d;"></span>
                </div>
                <div class="grid-board" id="board-2"></div>
                <div id="status-2" style="margin-top: 10px; font-weight: bold; color: var(--primary-color); min-height: 24px;"></div>
            </div>
        </div>

        <div style="flex: 1; min-width: 300px; background: #f8f9fa; padding: 15px; border-radius: 10px;">
            <h3>ğŸ› ï¸ ç¼–å†™ä½ çš„ç¨‹åº</h3>
            <p>ç‚¹å‡»æŒ‰é’®æ·»åŠ æŒ‡ä»¤ï¼š</p>
            <div class="controls" style="justify-content: flex-start;">
                <button class="action-btn" onclick="coder.add('up')">â†‘ Up</button>
                <button class="action-btn" onclick="coder.add('down')">â†“ Down</button>
                <button class="action-btn" onclick="coder.add('left')">â† Left</button>
                <button class="action-btn" onclick="coder.add('right')">â†’ Right</button>
            </div>
            
            <div class="code-display" id="code-output">
                </div>

            <div class="controls" style="justify-content: flex-start; margin-top: 15px;">
                <button onclick="coder.run()" style="background-color: #27ae60;">â–¶ï¸ æ‰§è¡Œç¨‹åº</button>
                <button class="secondary" onclick="coder.clear()">ğŸ—‘ï¸ æ¸…ç©ºæŒ‡ä»¤</button>
                <button class="secondary" onclick="coder.resetGame()">â†º é‡ç½®å…³å¡</button>
            </div>
        </div>
    </div>
</section>

<section id="part5">
    <h2>5. è¯¾å ‚æ€»ç»“ä¸æ‹“å±•</h2>
    <ul>
        <li>âœ… <strong>ç½‘æ ¼çš„ä½œç”¨ï¼š</strong> å¸®åŠ©æˆ‘ä»¬å‡†ç¡®æ ‡è¯†ä½ç½®å’Œæ–¹å‘ã€‚</li>
        <li>âœ… <strong>ç¼–ç çš„æ„ä¹‰ï¼š</strong> æ¸…æ™°æœ‰æ•ˆåœ°è¡¨ç¤ºåŠ¨ä½œåºåˆ—ï¼Œæ˜¯ä¸è®¡ç®—æœºæ²Ÿé€šçš„è¯­è¨€ã€‚</li>
    </ul>

    <div class="homework-card">
        <h3>ğŸ  è¯¾åå°ä»»åŠ¡ï¼šæ‰«åœ°æœºå™¨äººè§„åˆ’å¸ˆ </h3>
        <p>å®¶é‡Œçš„æ‰«åœ°æœºå™¨äººéœ€è¦è§„åˆ’è·¯çº¿ã€‚è¯·ä½ ï¼š</p>
        <ol>
            <li>ç”»å‡ºä½ æˆ¿é—´çš„å¹³é¢å›¾ï¼Œå¹¶ç”»ä¸Šç½‘æ ¼ã€‚</li>
            <li>è§„åˆ’ä¸€æ¡èƒ½æ‰«éç©ºåœ°ä½†ä¸æ’å¢™çš„è·¯çº¿ã€‚</li>
            <li>ç”¨ä»Šå¤©å­¦çš„ç¼–ç ï¼ˆå¦‚ â†‘ â†’ â†“ â†ï¼‰æŠŠå®ƒè®°å½•ä¸‹æ¥ã€‚</li>
        </ol>
    </div>
</section>

<script>
/**
 * ç®€æ˜“æ¸¸æˆå¼•æ“ - æ¨ç®±å­
 */
class SokobanGame {
    constructor(containerId, mapLayout, playerStart, isCodingMode = false) {
        this.container = document.getElementById(containerId);
        this.initialMap = JSON.parse(JSON.stringify(mapLayout)); // æ·±æ‹·è´
        this.initialPlayer = {...playerStart};
        this.map = mapLayout;
        this.player = playerStart;
        this.cols = mapLayout[0].length;
        this.rows = mapLayout.length;
        this.boxes = this.findItems(2); // 2 represents Box
        this.goals = this.findItems(3); // 3 represents Goal
        this.isCodingMode = isCodingMode;
        this.statusElement = document.getElementById(isCodingMode ? 'status-2' : 'status-1');
        
        this.init();
    }

    findItems(code) {
        const items = [];
        for(let y=0; y<this.rows; y++) {
            for(let x=0; x<this.cols; x++) {
                if(this.map[y][x] === code) items.push({x, y});
            }
        }
        return items;
    }

    init() {
        this.container.style.gridTemplateColumns = `repeat(${this.cols}, 50px)`;
        this.container.style.gridTemplateRows = `repeat(${this.rows}, 50px)`;
        this.render();
    }

    render() {
        this.container.innerHTML = '';
        for(let y=0; y<this.rows; y++) {
            for(let x=0; x<this.cols; x++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                
                const val = this.map[y][x];
                if (val === 1) cell.classList.add('wall');
                if (val === 3) cell.classList.add('goal');
                
                const hasBox = this.boxes.some(b => b.x === x && b.y === y);
                if (hasBox) {
                    const box = document.createElement('div');
                    box.className = 'sprite box';
                    cell.appendChild(box);
                }

                // Render Player
                if (this.player.x === x && this.player.y === y) {
                    const player = document.createElement('div');
                    player.className = 'sprite player';
                    cell.appendChild(player);
                }

                this.container.appendChild(cell);
            }
        }
    }

    async move(dx, dy) {
        const newX = this.player.x + dx;
        const newY = this.player.y + dy;

        // 1. Check boundary & Walls
        if (this.isWall(newX, newY)) return false;

        // 2. Check Box
        const boxIndex = this.boxes.findIndex(b => b.x === newX && b.y === newY);
        if (boxIndex >= 0) {
            const nextBoxX = newX + dx;
            const nextBoxY = newY + dy;
            
            // Check if box can move (not wall, not out of bounds)
            if (this.isWall(nextBoxX, nextBoxY)) return false;
            const hasNextBox = this.boxes.some(b => b.x === nextBoxX && b.y === nextBoxY);
            if (hasNextBox) return false;

            // Move Box
            this.boxes[boxIndex] = {x: nextBoxX, y: nextBoxY};
        }

        // 3. Move Player
        this.player = {x: newX, y: newY};
        this.render();
        this.checkWin();
        return true;
    }

    isWall(x, y) {
        if (x < 0 || x >= this.cols || y < 0 || y >= this.rows) return true;
        return this.map[y][x] === 1;
    }

    checkWin() {
        const goalSet = new Set(this.goals.map(g => `${g.x},${g.y}`));
        const win = this.boxes.length > 0 && this.boxes.every(b => goalSet.has(`${b.x},${b.y}`));
        if (win) {
            this.statusElement.innerText = "ğŸ‰ æ­å–œï¼ä»»åŠ¡å®Œæˆï¼";
            this.statusElement.classList.add('bounce');
            const cells = this.container.children;
            this.goals.forEach(g => {
                const index = g.y * this.cols + g.x;
                if (cells[index]) cells[index].style.backgroundColor = "#fff176";
            });
        } else {
             this.statusElement.classList.remove('bounce');
             if(!this.isCodingMode) this.statusElement.innerText = "";
        }
    }

    reset() {
        this.map = JSON.parse(JSON.stringify(this.initialMap)); // Restore map structure
        this.player = {...this.initialPlayer};
        this.boxes = this.findItems(2);
        this.statusElement.innerText = "";
        this.render();
    }

    loadLevel(mapLayout, playerStart) {
        this.initialMap = JSON.parse(JSON.stringify(mapLayout));
        this.initialPlayer = {...playerStart};
        this.map = mapLayout;
        this.player = {...playerStart};
        this.cols = mapLayout[0].length;
        this.rows = mapLayout.length;
        this.boxes = this.findItems(2);
        this.goals = this.findItems(3);
        this.statusElement.innerText = "";
        this.statusElement.classList.remove('bounce');
        this.init();
    }
}

/**
 * ç¼–ç¨‹æ§åˆ¶å™¨
 */
class CodeController {
    constructor(gameInstance, levels) {
        this.game = gameInstance;
        this.levels = levels;
        this.currentLevelIndex = 0;
        this.commands = [];
        this.display = document.getElementById('code-output');
        this.isRunning = false;
        this.levelSelect = document.getElementById('level-select');
        this.levelHint = document.getElementById('level-hint');

        this.initLevelUI();
    }

    add(direction) {
        if(this.isRunning) return;
        this.commands.push(direction);
        this.updateDisplay();
    }

    updateDisplay() {
        const symbolMap = { 'up': 'â†‘', 'down': 'â†“', 'left': 'â†', 'right': 'â†’' };
        this.display.innerHTML = this.commands.map(cmd => 
            `<span style="background:#444; padding:2px 6px; margin:2px; border-radius:4px; display:inline-block;">${symbolMap[cmd]} ${cmd}</span>`
        ).join('');
    }

    clear() {
        if(this.isRunning) return;
        this.commands = [];
        this.updateDisplay();
        this.game.reset();
    }

    resetGame() {
        if(this.isRunning) return;
        this.game.reset();
    }

    initLevelUI() {
        if (!this.levelSelect) return;
        this.levelSelect.innerHTML = '';
        this.levels.forEach((lvl, index) => {
            const option = document.createElement('option');
            option.value = String(index);
            option.textContent = lvl.title;
            this.levelSelect.appendChild(option);
        });
        this.setLevel(0);
    }

    setLevel(index) {
        if (this.isRunning) return;
        const nextIndex = Math.max(0, Math.min(this.levels.length - 1, index));
        this.currentLevelIndex = nextIndex;
        if (this.levelSelect) this.levelSelect.value = String(nextIndex);

        const level = this.levels[nextIndex];
        this.commands = [];
        this.updateDisplay();
        this.game.loadLevel(JSON.parse(JSON.stringify(level.map)), level.playerStart);

        if (this.levelHint) {
            this.levelHint.textContent = `éš¾åº¦ï¼š${level.difficulty}/5`;
        }

        const status = document.getElementById('status-2');
        status.innerText = "è¯·å…ˆè¾“å…¥æŒ‡ä»¤ï¼Œç„¶åç‚¹å‡»â€œæ‰§è¡Œç¨‹åºâ€ã€‚";
    }

    prevLevel() {
        this.setLevel(this.currentLevelIndex - 1);
    }

    nextLevel() {
        this.setLevel(this.currentLevelIndex + 1);
    }

    async run() {
        if (this.commands.length === 0) {
            alert("è¯·å…ˆè¾“å…¥æŒ‡ä»¤ï¼");
            return;
        }
        if (this.isRunning) return;

        this.isRunning = true;
        this.game.reset(); // Always start from clean slate
        
        let status = document.getElementById('status-2');
        status.innerText = "ğŸ¤– ç¨‹åºæ­£åœ¨æ‰§è¡Œ...";

        for (let i = 0; i < this.commands.length; i++) {
            await new Promise(r => setTimeout(r, 500)); // Delay for animation
            
            const cmd = this.commands[i];
            let dx=0, dy=0;
            if (cmd === 'up') dy = -1;
            if (cmd === 'down') dy = 1;
            if (cmd === 'left') dx = -1;
            if (cmd === 'right') dx = 1;

            // Highlight current command
            this.highlightCommand(i);
            
            await this.game.move(dx, dy);
        }
        
        this.isRunning = false;
        if(status.innerText !== "ğŸ‰ æ­å–œï¼ä»»åŠ¡å®Œæˆï¼") {
             status.innerText = "æ‰§è¡Œå®Œæ¯•ã€‚å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œè¯·ä¿®æ”¹ä»£ç å†è¯•ï¼";
        }
    }

    highlightCommand(index) {
        const spans = this.display.querySelectorAll('span');
        spans.forEach(s => s.style.border = "none");
        if(spans[index]) spans[index].style.border = "2px solid #fab1a0";
    }
}

// åˆå§‹åŒ–æ•°æ®
// 0: Empty, 1: Wall, 2: Box (Initial), 3: Goal
// Level 1 Map (Based on PPT Source 21/25 - 'S' shape path approximation)
const map1 = [
    [0, 0, 0, 3], // Goal top right
    [0, 0, 2, 0], // Box middle
    [0, 0, 0, 0]  // Player starts bottom left
];
const playerStart1 = {x: 0, y: 2};

function isLevelSolvable(map, playerStart) {
    const rows = map.length;
    const cols = map[0].length;
    const walls = (x, y) => {
        if (x < 0 || x >= cols || y < 0 || y >= rows) return true;
        return map[y][x] === 1;
    };

    const goals = [];
    const boxes = [];
    for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
            if (map[y][x] === 3) goals.push({x, y});
            if (map[y][x] === 2) boxes.push({x, y});
        }
    }
    if (boxes.length === 0 || goals.length === 0) return false;
    if (boxes.length !== goals.length) return false;

    const goalSet = new Set(goals.map(g => `${g.x},${g.y}`));
    const dirs = [
        {dx: 0, dy: -1},
        {dx: 0, dy: 1},
        {dx: -1, dy: 0},
        {dx: 1, dy: 0}
    ];

    const sortBoxes = (arr) => arr.slice().sort((a, b) => (a.y * cols + a.x) - (b.y * cols + b.x));
    const keyOf = (px, py, bxs) => {
        const s = sortBoxes(bxs).map(b => `${b.x},${b.y}`).join('|');
        return `${px},${py}#${s}`;
    };
    const hasBoxAt = (bxs, x, y) => bxs.some(b => b.x === x && b.y === y);
    const boxIndexAt = (bxs, x, y) => bxs.findIndex(b => b.x === x && b.y === y);
    const isWin = (bxs) => bxs.every(b => goalSet.has(`${b.x},${b.y}`));

    const startKey = keyOf(playerStart.x, playerStart.y, boxes);
    const visited = new Set([startKey]);
    const queue = [{px: playerStart.x, py: playerStart.y, bxs: boxes}];
    let head = 0;
    const maxStates = 160000;

    while (head < queue.length && visited.size < maxStates) {
        const state = queue[head++];
        if (isWin(state.bxs)) return true;

        for (const d of dirs) {
            const nx = state.px + d.dx;
            const ny = state.py + d.dy;
            if (walls(nx, ny)) continue;

            const bi = boxIndexAt(state.bxs, nx, ny);
            if (bi >= 0) {
                const nbx = nx + d.dx;
                const nby = ny + d.dy;
                if (walls(nbx, nby)) continue;
                if (hasBoxAt(state.bxs, nbx, nby)) continue;
                const nextBoxes = state.bxs.map(b => ({...b}));
                nextBoxes[bi] = {x: nbx, y: nby};
                const k = keyOf(nx, ny, nextBoxes);
                if (!visited.has(k)) {
                    visited.add(k);
                    queue.push({px: nx, py: ny, bxs: nextBoxes});
                }
            } else {
                const k = keyOf(nx, ny, state.bxs);
                if (!visited.has(k)) {
                    visited.add(k);
                    queue.push({px: nx, py: ny, bxs: state.bxs});
                }
            }
        }
    }

    return false;
}

const codingLevelsAll = [
    {
        title: "ç¬¬1å…³ï¼šå…¥é—¨ç›´çº¿",
        difficulty: 1,
        map: [
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0],
            [0, 2, 0, 0, 1, 0],
            [0, 0, 0, 0, 0, 3]
        ],
        playerStart: {x: 0, y: 3}
    },
    {
        title: "ç¬¬2å…³ï¼šç»•å¼€éšœç¢",
        difficulty: 2,
        map: [
            [1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 2, 0, 0, 1],
            [1, 0, 1, 1, 1, 0, 1],
            [1, 0, 0, 0, 0, 3, 1],
            [1, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 1, 1, 1]
        ],
        playerStart: {x: 1, y: 5}
    },
    {
        title: "ç¬¬3å…³ï¼šé•¿èµ°å»Šæ¨è¿›",
        difficulty: 3,
        map: [
            [1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 3, 0, 2, 0, 0, 1],
            [1, 0, 1, 1, 1, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1]
        ],
        playerStart: {x: 1, y: 5}
    },
    {
        title: "ç¬¬4å…³ï¼šåŒç®±åŒç›®æ ‡",
        difficulty: 3,
        map: [
            [1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 2, 0, 3, 0, 0, 1],
            [1, 0, 0, 1, 1, 0, 0, 1],
            [1, 0, 0, 0, 0, 2, 0, 1],
            [1, 0, 0, 0, 0, 0, 3, 1],
            [1, 1, 1, 1, 1, 1, 1, 1]
        ],
        playerStart: {x: 1, y: 5}
    },
    {
        title: "ç¬¬5å…³ï¼šåŒç®±é¡ºåºå¾ˆé‡è¦",
        difficulty: 4,
        map: [
            [1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 2, 1, 1, 0, 3, 0, 1],
            [1, 0, 0, 1, 0, 0, 0, 0, 1],
            [1, 0, 0, 1, 0, 1, 1, 0, 1],
            [1, 0, 0, 0, 0, 0, 2, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 3, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1]
        ],
        playerStart: {x: 1, y: 6}
    },
    {
        title: "ç¬¬6å…³ï¼šä¸‰ç®±æŒ‘æˆ˜",
        difficulty: 5,
        map: [
            [1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 2, 0, 1, 0, 3, 0, 1],
            [1, 0, 0, 0, 1, 0, 0, 0, 1],
            [1, 0, 2, 0, 0, 0, 3, 0, 1],
            [1, 0, 0, 1, 1, 1, 0, 0, 1],
            [1, 0, 2, 0, 0, 0, 3, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1]
        ],
        playerStart: {x: 1, y: 7}
    }
];

const codingLevels = codingLevelsAll.filter(lvl => isLevelSolvable(lvl.map, lvl.playerStart));

const game1 = new SokobanGame('board-1', map1, playerStart1);
const game2 = new SokobanGame('board-2', JSON.parse(JSON.stringify(codingLevels[0].map)), codingLevels[0].playerStart, true);
const coder = new CodeController(game2, codingLevels);

// é”®ç›˜æ§åˆ¶ç»‘å®š (ä»…é™ Level 1)
document.addEventListener('keydown', (e) => {
    // åªæœ‰å½“Level 1åœ¨è§†å£å†…æ—¶æ‰å“åº”
    const rect = document.getElementById('game-level-1').getBoundingClientRect();
    if (rect.top >= -200 && rect.bottom <= window.innerHeight + 200) {
        if(e.key === "ArrowUp") { e.preventDefault(); game1.move(0, -1); }
        if(e.key === "ArrowDown") { e.preventDefault(); game1.move(0, 1); }
        if(e.key === "ArrowLeft") { e.preventDefault(); game1.move(-1, 0); }
        if(e.key === "ArrowRight") { e.preventDefault(); game1.move(1, 0); }
    }
});

</script>

</body>
</html>
